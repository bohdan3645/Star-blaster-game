<!DOCTYPE html>
<html>
    <body>
        <canvas id="canvas">

        </canvas>
        <script>
            const canv = document.getElementById("canvas");
            const ctx = canv.getContext("2d");

            canv.width = 300;
            canv.height = 300;

            class Bullet {
                constructor(shipWidth) {
                    this.id = Date.now() + Math.random();
                    this.isActive = false;
                    this.color = 'red';
                    this.height = 15;
                    this.width = 5;
                    this.startPositionX = 0;
                    this.positionOffsetY = 0;
                    this.positionOffsetX = (shipWidth - this.width) / 2;
                    this.step = 10;
                    this.isOffCanv = false;
                }

                drawBullet(positionX, positionY) {
                    //track current ship's position if bullet is passive
                    if(!this.isActive) {
                        this.startPositionX = positionX + this.positionOffsetX;
                    }

                    //move bullet up if active
                    if(this.isActive) {
                        this.positionOffsetY += this.step;
                    }

                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.startPositionX, positionY - this.positionOffsetY, this.width, this.height);
                }

                activate(positionX) {
                    this.isActive = true;

                    //get bullet x possition if active
                    this.startPositionX = positionX + this.positionOffsetX;
                }

                //checks if bullet is out of canvas
                checkIsOffCanv(canvHeight) {
                    if(this.positionOffsetY > canvHeight) {
                        this.isOffCanv = true;
                    };
                }
            }

            class Foe {
                constructor(positionX, positionY) {
                    this.id = Date.now() + Math.random();
                    this.color = 'violet';
                    this.width = 30;
                    this.height = 30;
                    this.position = {
                            x: positionX,
                            y: positionY
                        };
                }
                drawFoe() {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.position.x, this.position.y, this.width, this.height);
                }
            }

            const spaceShip = {
                color: "blue",
                width: 30,
                height: 30,
                position: {
                    x: 0,
                    y: 0
                },
                step: 10,
                charge: [],

                setInitialShipPosition() {
                    this.position.x = canv.width / 2 - this.width / 2;
                    this.position.y = canv.height - spaceShip.height
                },

                drawShip() {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.position.x, this.position.y, this.width, this.height);
                },

                drawBullets() {
                    //load gun if empty
                    if(this.charge.length < 1) {
                        this.charge.push(new Bullet(this.width));
                    };

                    this.charge.forEach(bullet => {
                        bullet.drawBullet(this.position.x, canv.height - this.width);

                        //check if bullets are out of canvas
                        bullet.checkIsOffCanv(canv.height);
                    });

                    //clean bullets that are out of canvas
                    this.charge = this.charge.filter(bullet => {
                        return bullet.isOffCanv === false;
                    });
                },

                shot() {
                    //reload gun
                    this.charge.unshift(new Bullet(this.width));

                    //shot first bullet in charge
                    this.charge[0].activate(this.position.x);
                }
            }



            spaceShip.setInitialShipPosition();

            const foesNum = 7;
            const positionY = 10;
            let foes = [];
            for(let i = 0; i < 7; i++) {
                const spaceBetween = (canv.width - foesNum * 30) / (foesNum + 1);
                foes.push(new Foe(30 * i + spaceBetween * (i + 1), positionY));
            }

            setInterval(() => {
                //draw canvas background
                ctx.fillStyle = "grey";
                ctx.fillRect(0, 0, canv.width, canv.height);

                //draw ship
                spaceShip.drawShip();

                //draw foes
                foes.forEach(foe => {
                    foe.drawFoe();
                });

                //detect collision
                spaceShip.charge.forEach(bullet => {
                    if((canv.height - bullet.positionOffsetY - 60) === positionY) {
                        const bulletContactArea = { leftConer: bullet.startPositionX, rightConer: bullet.startPositionX + bullet.width};
                        foes.forEach((foe, i) => {
                            const foeContactArea = { leftConer: foe.position.x, rightConer: foe.position.x + foe.width };
                            if((bulletContactArea.leftConer >= foeContactArea.leftConer && bulletContactArea.leftConer <= foeContactArea.rightConer) ||
                            (bulletContactArea.rightConer >= foeContactArea.leftConer && bulletContactArea.rightConer <= foeContactArea.rightConer)) {
                                //kill foe
                                foes = foes.filter(fo => {
                                    return fo.id !== foe.id
                                })
                                //remove bullet
                                spaceShip.charge = spaceShip.charge.filter(bul => {
                                    return bul.id !== bullet.id;
                                })
                            };
                        });
                    };
                });

                //draw all bullets
                spaceShip.drawBullets();

                //preven ship form going beyond canvas
                if(spaceShip.position.x > canv.width - spaceShip.width){
                    spaceShip.position.x = canv.width - spaceShip.width
                }
                if(spaceShip.position.x < 0){
                    spaceShip.position.x = 0;
                }
            }, 50);


            let clearLeft = null;
            let clearRight = null;
            document.addEventListener("keydown", (e) => {
                if(e.code === "ArrowLeft"){
                    if(e.repeat) return;
                    if(clearRight) {
                        clearInterval(clearRight);
                        clear = null;
                    }
                    if(clearLeft) {
                        clearInterval(clearLeft);
                        clear = null;
                    }
                    clearLeft = setInterval(() => {spaceShip.position.x -= spaceShip.step}, 50);
                };

                if(e.code === "ArrowRight"){
                    if(e.repeat) return;
                    if(clearLeft) {
                        clearInterval(clearLeft);
                        clear = null;
                    }
                    if(clearRight) {
                        clearInterval(clearRight);
                        clear = null;
                    }
                    clearRight = setInterval(() => {spaceShip.position.x += spaceShip.step}, 50);
                };
                
                if(e.code === "Space"){
                    if(e.repeat) return;
                    spaceShip.shot();
                };
            })

            document.addEventListener('keyup' , (e) => {
                if(e.code === "ArrowLeft") {
                    if(!clearLeft) return;
                    clearInterval(clearLeft);
                    clearLeft = null;
                };
                if(e.code === "ArrowRight") {
                    if(!clearRight) return;
                    clearInterval(clearRight);
                    clearRight = null;
                };
            })

        </script>
    </body>
</html>